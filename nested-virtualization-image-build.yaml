steps:
- id: 'create_disk_for_nested_image'
  name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-c'
    -  |
       if [[ -z $(gcloud compute disks list \
           --format='value(name)' \
           --filter='name=nested-agent-disk' ) ]]; then
           gcloud compute disks create nested-agent-disk \
           --image-project centos-cloud \
           --image-family centos-7 \
           --zone ${_IMAGE_ZONE}
       else
         echo "nested-agent-disk exists"
         exit 0
       fi
- id: 'create_nested_virtualization_image'
  name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: "bash"
  args:
    - '-c'
    - |
      if [[ -z $(gcloud compute images list \
          --format='value(name)' \
          --filter='name=nested-vm-image' ) ]]; then
          gcloud compute images create nested-vm-image \
          --source-disk disk1 \
          --source-disk-zone ${_IMAGE_ZONE} \
          --licenses \
           "https://www.googleapis.com/compute/v1/\
           projects/vm-options/global/licenses/enable-vmx"
      else
         echo "nested-agent-disk exists"
         exit 0
      fi
